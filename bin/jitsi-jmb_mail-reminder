#!/bin/bash

########################################################################
# Archivage des réservation expirées
########################################################################

# On vérifie si le JMS tourne sur une machine HA (ssds-ha)
test -x /usr/local/ssds_ha/ha-state
if [ ${?} -eq 0 ] ; then
	# On ne continue que si on est sur le noeud actif
	/usr/local/ssds_ha/ha-state -q || exit 0
fi

# Timestamp
now=$(date +%s)

########################################################################

# Charger la configuration et les fonctions
JMB_PATH=/opt/jitsi-jmb
source ${JMB_PATH}/etc/jmb.cf
source ${JMB_PATH}/lib/jmb.lib

########################################################################

mail_tpl="${JMB_PATH}/inc/mail_tpl_reminder.sh"

# Si l'adresse de l'organisateur ne correspond pas au domaine du serveur
# Jitsi, on remplace l'adresse d'enveloppe pour passer les contrôles SPF
echo "${auth_mail}" |egrep -q "${JMB_MAIL_DOMAIN//\./\\.}$"
if [ $? -eq 0 ] ; then
	envelope_from="${auth_mail}"
else
	envelope_from="${JMB_MAIL_FROM_NOTIFICATION}"
fi

# Récupérer les IDs des réunions pour lesquelles un rappel doit être envoyé -> variable "${tsn}"
for f in $(\
	sqlite3 ${JMB_DB} "\
	SELECT mail_reminder_meeting_id FROM mail_reminder
	WHERE '${now}' >= mail_reminder_date AND mail_reminder_done = '0';") ; do

	# Lire les données de la réunion
	get_meeting_infos ${f}

	# La durée est stockée en secondes, le mail indique des minutes
	duration=$(( ${duration} / 60 ))

	# Rappel à l'organisateur
	mailto="${owner}"
	role="owner"
	source ${mail_tpl} |mail\
		-a "Content-Type: text/plain; charset=utf-8; format=flowed"\
		-a "Content-Transfer-Encoding: 8bit"\
		-a "Content-Language: fr"\
		-a "from: ${JMB_MAIL_FROM_NOTIFICATION}"\
		-a "subject: $(utf8_to_mime ${JMB_SUBJECT_MAIL_REMINDER_OWNER})"\
		${mailto}

	# Rappel aux invités
	role="guest"
	for mailto in ${guests} ; do
		get_meeting_hash ${f} ${mailto} ${role}
		# Mail de notification
		source ${mail_tpl} |mail\
			-r "${envelope_from}"\
			-a "Content-Type: text/plain; charset=utf-8; format=flowed"\
			-a "Content-Transfer-Encoding: 8bit"\
			-a "Content-Language: fr"\
			-a "from: ${owner}"\
			-a "subject: $(utf8_to_mime ${JMB_SUBJECT_MAIL_REMINDER_GUEST})"\
			${mailto}
	done

	# Rappel aux modérateurs
	role="moderator"
	for mailto in ${moderators} ; do
		get_meeting_hash ${f} ${mailto} ${role}
		# Mail de notification
		source ${mail_tpl} |mail\
			-r "${envelope_from}"\
			-a "Content-Type: text/plain; charset=utf-8; format=flowed"\
			-a "Content-Transfer-Encoding: 8bit"\
			-a "Content-Language: fr"\
			-a "from: ${owner}"\
			-a "subject: $(utf8_to_mime ${JMB_SUBJECT_MAIL_REMINDER_MODERATOR})"\
			${mailto}
	done

	# Reminder "consommé" -> on le désactive
	echo "UPDATE mail_reminder SET mail_reminder_done='1' WHERE mail_reminder_meeting_id='${f}' AND mail_reminder_date < '${now}';" |sqlite3 ${JMB_DB}

done
